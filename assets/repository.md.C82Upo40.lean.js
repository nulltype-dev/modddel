import{_ as e,c as i,a1 as a,o as t}from"./chunks/framework.5g2C1WLa.js";const g=JSON.parse('{"title":"Repository","description":"","frontmatter":{},"headers":[],"relativePath":"repository.md","filePath":"repository.md"}'),n={name:"repository.md"};function h(r,s,l,o,p,d){return t(),i("div",null,s[0]||(s[0]=[a(`<h1 id="repository" tabindex="-1">Repository <a class="header-anchor" href="#repository" aria-label="Permalink to &quot;Repository&quot;">​</a></h1><p>In this guide, we will cover how to implement and use the <code>Repository</code> class in the Modddel framework. The repository pattern helps separate the domain logic from the persistence mechanism, ensuring clean and maintainable code. It is also crucial for managing aggregates, events, and snapshots in a Domain-Driven Design (DDD) environment.</p><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>A repository in this framework serves as the interface to load and save aggregate roots. It abstracts away the underlying event store and optional snapshot store, providing a consistent API to manage the lifecycle of aggregates. The repository handles:</p><ul><li>Storing events emitted by aggregates.</li><li>Loading aggregate state either from history (event sourcing) or from a snapshot.</li><li>Publishing domain events when they are recorded and saved.</li></ul><h3 id="key-concepts" tabindex="-1">Key Concepts <a class="header-anchor" href="#key-concepts" aria-label="Permalink to &quot;Key Concepts&quot;">​</a></h3><ul><li><strong>Event Store</strong>: Stores the history of domain events for aggregates.</li><li><strong>Snapshot Store</strong>: Optionally stores snapshots of aggregates to optimize loading by reducing the need to replay events.</li><li><strong>Concurrency Handling</strong>: Ensures that concurrent modifications of the same aggregate are managed correctly.</li><li><strong>Subscriptions</strong>: Allows you to listen for events when they are recorded and published.</li></ul><hr><h2 id="setting-up-the-repository" tabindex="-1">Setting Up the Repository <a class="header-anchor" href="#setting-up-the-repository" aria-label="Permalink to &quot;Setting Up the Repository&quot;">​</a></h2><p>The repository can be created with or without snapshot support. Here&#39;s how to configure a repository:</p><h3 id="creating-a-repository" tabindex="-1">Creating a Repository <a class="header-anchor" href="#creating-a-repository" aria-label="Permalink to &quot;Creating a Repository&quot;">​</a></h3><p>The repository can be created by providing an event store. Optionally, you can enable snapshots to improve performance by reducing the need to replay all events when loading an aggregate.</p><p>In the repository, an event store is responsible for saving and loading events. Here&#39;s a basic implementation:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EventStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IEventStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  getAggregateVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">definition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Returns the latest version of an aggregate by checking events and snapshots</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  loadHistory</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">definition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">sinceVersion</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Loads the history of events for the aggregate from the event store</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  saveEvents</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">newEvents</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Saves new events to the event store</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>The snapshot store allows to load and save snapshots. The interface contains two additional methods :</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> EventStore</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> IEventStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ISnapshotStore</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  loadSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">aggregateDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Loads a snapshot if available for the given aggregate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  saveSnapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">aggregateDefinition</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">snapshot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Saves a snapshot of the aggregate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  },</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>You can also use the repository as snapshot only repository. To do this leave the saveEvents method empty, and return empty array in the loadHistory. The getAggregateVersion must return valid version (it can be based on the snapshot).</p></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If you are using event store then you don&#39;t have to write snapshot on every save. Check conditions you want in saveSnapshot. For example, we can check if <code>snapshot.version % 100 === 0</code> is true and then persist in the database.</p></div><h2 id="loading-and-saving-aggregates" tabindex="-1">Loading and Saving Aggregates <a class="header-anchor" href="#loading-and-saving-aggregates" aria-label="Permalink to &quot;Loading and Saving Aggregates&quot;">​</a></h2><h3 id="loading-an-aggregate" tabindex="-1">Loading an Aggregate <a class="header-anchor" href="#loading-an-aggregate" aria-label="Permalink to &quot;Loading an Aggregate&quot;">​</a></h3><p>The repository can load an aggregate from either the event store or from a snapshot, if available. If the snapshot is not up to date, the repository will load additional events from the event store to update the aggregate&#39;s state.</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> cart</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> await</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> repository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ShoppingCart, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cart-1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><h3 id="saving-an-aggregate" tabindex="-1">Saving an Aggregate <a class="header-anchor" href="#saving-an-aggregate" aria-label="Permalink to &quot;Saving an Aggregate&quot;">​</a></h3><p>Once an aggregate has recorded events through its actions, those events need to be saved using the repository. When saving, the repository handles event persistence and emits the events to any listeners.</p><h2 id="event-streaming" tabindex="-1">Event Streaming <a class="header-anchor" href="#event-streaming" aria-label="Permalink to &quot;Event Streaming&quot;">​</a></h2><p>Repositories allow subscribing to events emitted by aggregates. You can subscribe to two types of events:</p><ul><li><code>eventsRecorded</code>: Fired when an event is recorded by an aggregate <strong>before</strong> saving to the event store.</li><li><code>eventsPublished</code>: Fired when an event is successfully saved to the event store and persisted.</li></ul><h3 id="differences-between-eventrecorded-and-eventpublished" tabindex="-1">Differences Between <code>eventRecorded</code> and <code>eventPublished</code> <a class="header-anchor" href="#differences-between-eventrecorded-and-eventpublished" aria-label="Permalink to &quot;Differences Between \`eventRecorded\` and \`eventPublished\`&quot;">​</a></h3><ul><li><p><strong><code>eventRecorded</code></strong>: This event is emitted immediately after the aggregate records an event but <strong>before</strong> any events are persisted. It&#39;s ideal for listeners that <strong>must be executed prior to saving</strong>, such as validation checks or pre-persistence logic.</p><ul><li><strong>Important:</strong> If an exception is thrown in any of the listeners subscribed to <code>eventRecorded</code>, the events and any associated snapshots will <strong>not be saved</strong>. This ensures that no invalid or incomplete state changes are persisted if there&#39;s an issue with the event listeners.</li></ul><p>This makes <code>eventRecorded</code> perfect for actions where the listeners need to guarantee execution <strong>before</strong> saving or where the application must guarantee that no events are saved unless all listeners execute successfully.</p></li><li><p><strong><code>eventPublished</code></strong>: This event is emitted <strong>after</strong> the events have been successfully saved to the event store. It is best suited for listeners where it&#39;s acceptable for the listeners to fail or not execute without affecting the persistence of the aggregate’s state (e.g., sending notifications or logging). Since the aggregate&#39;s state has already been persisted, any error that occurs in <code>eventPublished</code> listeners will <strong>not affect the saved state</strong>.</p><p><code>eventPublished</code> is useful for side effects or tasks that can happen optionally, where it&#39;s fine for them to fail or be skipped due to errors, because the changes to events in this listeners won&#39;t be persisted.</p></li></ul><h3 id="example-listening-for-recorded-and-published-events" tabindex="-1">Example: Listening for Recorded and Published Events <a class="header-anchor" href="#example-listening-for-recorded-and-published-events" aria-label="Permalink to &quot;Example: Listening for Recorded and Published Events&quot;">​</a></h3><p>You can subscribe to event streams using the repository’s <code>subscribe</code> method:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">repository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;eventsRecorded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Events recorded: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Perform critical tasks here (e.g., validation)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">repository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">subscribe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;eventsPublished&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">events</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">log</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">\`Event published: \${</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">events</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">map</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">((</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> event</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">name</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">}\`</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Perform non-critical tasks here (e.g., notifications)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">});</span></span></code></pre></div><h2 id="concurrency-handling" tabindex="-1">Concurrency Handling <a class="header-anchor" href="#concurrency-handling" aria-label="Permalink to &quot;Concurrency Handling&quot;">​</a></h2><p>The repository enforces concurrency control by ensuring that no two instances of the same aggregate can be modified at the same time without conflict. This prevents data inconsistency in cases where two processes attempt to modify the same aggregate concurrently.</p><h3 id="handling-concurrency-errors" tabindex="-1">Handling Concurrency Errors <a class="header-anchor" href="#handling-concurrency-errors" aria-label="Permalink to &quot;Handling Concurrency Errors&quot;">​</a></h3><p>If two newly created aggregates with the same ID are saved concurrently, the repository will throw a concurrency error:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">try</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  await</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Promise</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">all</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([repository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cart1), repository.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">save</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cart2)]);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">catch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (error) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  console.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Concurrency error:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>In this example, both cart1 and cart2 represent the same aggregate (cart-1). Attempting to save both concurrently will result in an error, as the aggregate&#39;s version will have changed during the first save, causing the second save to fail.</p><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to &quot;Conclusion&quot;">​</a></h2><p>The Repository class in the Modddel framework is a crucial component for managing aggregates, events, and snapshots in a clean and efficient way. By abstracting the event and snapshot stores, it provides a consistent API for handling the persistence of aggregates and ensures that domain events are correctly recorded and published.</p><p>The repository pattern simplifies aggregate management while supporting event sourcing and snapshotting for optimized performance, making it an essential part of building scalable DDD applications.</p>`,41)]))}const c=e(n,[["render",h]]);export{g as __pageData,c as default};
